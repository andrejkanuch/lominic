# GraphQL Setup for Lominic Web

This document explains the GraphQL setup in the web application using Apollo Client and GraphQL Code Generator.

## Architecture

- **Apollo Client**: For GraphQL client operations
- **GraphQL Code Generator**: For type-safe GraphQL operations
- **Custom Hooks**: For reusable GraphQL logic

## File Structure

```
src/
├── gql/                    # Generated GraphQL types and hooks
│   ├── graphql.ts         # Auto-generated by codegen
│   └── index.ts           # Re-exports
├── graphql/               # GraphQL queries and mutations
│   └── queries.ts         # Manual GraphQL operations
├── hooks/                 # Custom React hooks
│   └── use-graphql.ts     # Custom GraphQL hooks
└── lib/
    └── apollo-client.ts   # Apollo Client configuration
```

## Setup

### 1. Dependencies

The following packages are installed:

```json
{
  "@apollo/client": "^3.13.8",
  "@graphql-codegen/cli": "^5.0.7",
  "@graphql-codegen/client-preset": "^4.2.4",
  "@graphql-codegen/typescript": "^4.1.6",
  "@graphql-codegen/typescript-operations": "^4.6.1",
  "@graphql-codegen/typescript-react-apollo": "^4.3.3",
  "@graphql-codegen/typescript-resolvers": "^4.1.1",
  "@graphql-codegen/typed-document-node": "^5.1.1"
}
```

### 2. Codegen Configuration

The `codegen.ts` file configures GraphQL Code Generator:

```typescript
import { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  schema: "http://localhost:4000/graphql",
  documents: ["src/**/*.tsx", "src/**/*.ts"],
  generates: {
    "./src/gql/": {
      preset: "client",
      presetConfig: {
        gqlTagName: "gql",
        fragmentMasking: false,
      },
      config: {
        scalars: {
          DateTime: "string",
        },
        useTypeImports: true,
        skipTypename: false,
        withHooks: true,
        withComponent: false,
        withHOC: false,
        dedupeOperationSuffix: true,
        dedupeFragments: true,
      },
    },
  },
  ignoreNoDocuments: true,
};
```

### 3. Apollo Client Configuration

The Apollo Client is configured with:

- **Authentication**: Automatic token injection from localStorage
- **Error Handling**: Global error logging
- **Cache Policies**: Optimized for user data
- **Type Policies**: Proper cache normalization

## Usage

### 1. Using Generated Hooks

After running codegen, you can use the generated hooks:

```typescript
import { useGetUsersQuery, useLoginMutation } from "../gql/graphql";

function UsersList() {
  const { data, loading, error } = useGetUsersQuery();
  const [login, { loading: loginLoading }] = useLoginMutation();

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;

  return (
    <div>
      {data?.users.map((user) => (
        <div key={user.id}>
          {user.firstName} {user.lastName}
        </div>
      ))}
    </div>
  );
}
```

### 2. Using Custom Hooks

For more complex operations, use the custom hooks:

```typescript
import { useAuth, useUsers } from "../hooks/use-graphql";

function AuthComponent() {
  const { login, loginLoading, loginError } = useAuth();
  const { users, createUser, updateUser, removeUser } = useUsers();

  const handleLogin = async () => {
    try {
      const result = await login("user@example.com", "password");
      if (result) {
        console.log("Logged in:", result.user);
      }
    } catch (error) {
      console.error("Login failed:", error);
    }
  };

  return (
    <div>
      <button onClick={handleLogin} disabled={loginLoading}>
        {loginLoading ? "Logging in..." : "Login"}
      </button>
      {loginError && <div>Error: {loginError.message}</div>}
    </div>
  );
}
```

### 3. Manual GraphQL Operations

For one-off operations, you can use the queries directly:

```typescript
import { useMutation } from "@apollo/client";
import { LOGIN } from "../graphql/queries";

function LoginForm() {
  const [login, { loading, error }] = useMutation(LOGIN);

  const handleSubmit = async (formData) => {
    try {
      const result = await login({
        variables: {
          loginInput: {
            email: formData.email,
            password: formData.password,
          },
        },
      });

      if (result.data?.login?.access_token) {
        localStorage.setItem("access_token", result.data.login.access_token);
      }
    } catch (error) {
      console.error("Login failed:", error);
    }
  };

  return <form onSubmit={handleSubmit}>{/* form fields */}</form>;
}
```

## Available Operations

### Queries

- `GetUsers`: Fetch all users
- `GetUser`: Fetch a single user by ID

### Mutations

- `Login`: Authenticate user
- `Register`: Create new user account
- `CreateUser`: Create user (admin only)
- `UpdateUser`: Update user information
- `RemoveUser`: Delete user (admin only)

## Development Workflow

### 1. Start the API

```bash
cd apps/api
pnpm run start:dev
```

### 2. Generate Types

```bash
cd apps/web
pnpm codegen
```

### 3. Watch for Changes

```bash
pnpm codegen:watch
```

### 4. Use in Components

Import and use the generated hooks or custom hooks in your React components.

## Best Practices

1. **Use Custom Hooks**: For complex operations, use the custom hooks in `use-graphql.ts`
2. **Error Handling**: Always handle errors in your components
3. **Loading States**: Show loading indicators during operations
4. **Cache Management**: Use `refetchQueries` for cache invalidation
5. **Type Safety**: Leverage the generated TypeScript types

## Troubleshooting

### Common Issues

1. **Schema not found**: Ensure the API is running on `http://localhost:4000`
2. **Type errors**: Run `pnpm codegen` after schema changes
3. **Cache issues**: Use `refetchQueries` or clear cache manually
4. **Authentication**: Check localStorage for valid tokens

### Regenerating Types

If you encounter type issues:

```bash
# Remove generated files
rm -rf src/gql/

# Regenerate
pnpm codegen
```

## Future Enhancements

- [ ] Add GraphQL fragments for reusable field selections
- [ ] Implement optimistic updates
- [ ] Add subscription support for real-time updates
- [ ] Implement offline support with Apollo Cache Persist
- [ ] Add GraphQL error boundaries
